"""
FLEXIBLE FIELD LIBRARY - Medical Credentials
UPDATED: Email domain restriction, Multiple licenses with issue dates
"""

FIELD_LIBRARY = {
    # =========================================================================
    # PERSONAL INFORMATION
    # =========================================================================
    
    "first_name": {
        "description": "First/Given name of the individual",
        "examples": ["John", "Mary", "Robert", "Jennifer", "Michael"],
        "format": "Capitalized text, may include middle initial",
        "extraction_hints": [
            "May be split across multiple lines",
            "Check for 'First Name' and 'Given Name' labels",
            "Look for 'Full Name' or 'Name of Holder' sections",
            "Sometimes appears as 'Nom' or 'Name of Holder'",
            "Can be in format: First Middle Last OR Given Names Surname"
        ],
        "confidence_factors": [
            "Clear text with proper spacing",
            "Consistent formatting across document",
            "Matches expected name pattern",
            "Found near expected location (top of document)"
        ]
    },
    
    "last_name": {
        "description": "Last/Family name of the individual",
        "examples": ["Smith", "Johnson", "Williams", "Brown", "Garcia"],
        "format": "Capitalized text, may include suffixes (Jr., Sr., III, MD, DO)",
        "extraction_hints": [
            "May be split across multiple lines",
            "Check for 'Last Name', 'Surname', 'Family Name' labels",
            "Look for 'Full Name' or 'Name of Holder' sections",
            "May include professional suffixes (MD, DO, DDS)",
            "Sometimes appears as 'Surname' or after given names"
        ],
        "confidence_factors": [
            "Clear text with proper spacing",
            "Consistent formatting across document",
            "Matches expected surname pattern",
            "Found near expected location"
        ]
    },
    
    "email": {
        "description": "Company/Professional email address ONLY (domain-specific)",
        "examples": [
            "john.doe@mpowerhealth.com", 
            "mary.smith@vkhealth.com",
            "doctor@hospitalgroup.org",
            "provider@medicalcenter.com"
        ],
        "format": "username@companydomain.com - MUST be company/organization domain",
        "extraction_hints": [
            "Look for 'Email', 'E-mail', 'Email Address', 'Work Email' labels",
            "ONLY extract company/professional emails (e.g., @mpowerhealth.com, @vkhealth.com)",
            "IGNORE personal emails (gmail.com, yahoo.com, hotmail.com, outlook.com)",
            "Must be organization/hospital/clinic domain",
            "Usually ends with .com, .org, .edu for healthcare organizations",
            "If only personal email found, return 'NA'"
        ],
        "confidence_factors": [
            "Contains @ symbol with company domain",
            "NOT a personal email provider (gmail, yahoo, etc)",
            "Matches professional/organizational domain pattern",
            "Found in contact section"
        ]
    },
    
    "cell": {
        "description": "Cell/Mobile phone number",
        "examples": ["(555) 123-4567", "555-123-4567", "5551234567", "+1-555-123-4567"],
        "format": "10 digits, may include formatting: (XXX) XXX-XXXX or XXX-XXX-XXXX",
        "extraction_hints": [
            "Look for 'Cell', 'Mobile', 'Cell Phone', 'Mobile Number' labels",
            "Extract 10-digit number, preserve formatting if present",
            "May be labeled as 'Primary Phone' or 'Contact Number'",
            "Could include country code (+1)",
            "Sometimes in format: (XXX) XXX-XXXX or XXX.XXX.XXXX"
        ],
        "confidence_factors": [
            "Contains 10 digits",
            "Has standard phone formatting",
            "Clear and complete number",
            "Found in contact section"
        ]
    },
    
    "birth_date": {
        "description": "Date of birth",
        "examples": ["01/15/1985", "1985-01-15", "January 15, 1985", "15-Jan-1985"],
        "format": "MM/DD/YYYY or YYYY-MM-DD or Month DD, YYYY",
        "extraction_hints": [
            "Look for 'DOB', 'Date of Birth', 'Birth Date', 'Born' labels",
            "Convert to consistent format: MM/DD/YYYY",
            "Validate date is reasonable (person is 25-80 years old for doctors)",
            "May be formatted as DD/MM/YYYY in some documents",
            "Check personal information section"
        ],
        "confidence_factors": [
            "Valid date format",
            "Reasonable age for medical professional (25-80)",
            "Clear and complete date",
            "Found in personal info section"
        ]
    },
    
    "birth_place": {
        "description": "Complete birth place (city, state/province, country)",
        "examples": ["New York, NY, USA", "London, UK", "Toronto, ON, Canada", "Chicago, IL"],
        "format": "City, State/Province, Country (or partial if not all available)",
        "extraction_hints": [
            "Look for 'Place of Birth', 'Birth Place', 'Born in', 'POB' labels",
            "May be combined field or separate fields",
            "Include all location details available",
            "Sometimes split into city, state, country fields",
            "May only have city or city+state (extract what's available)"
        ],
        "confidence_factors": [
            "Complete location information",
            "Standard place name format",
            "Clear and readable",
            "Found in personal info section"
        ]
    },
    
    "birth_city": {
        "description": "City of birth",
        "examples": ["New York", "Los Angeles", "Chicago", "Houston", "Phoenix"],
        "format": "City name only",
        "extraction_hints": [
            "Look for 'Birth City', 'City of Birth' labels",
            "Extract city portion from full birth place if available",
            "May be in separate 'City' field under birth information",
            "Usually appears before state in address format",
            "Check both 'Birth Place' and separate 'City' fields"
        ],
        "confidence_factors": [
            "Valid city name",
            "Consistent with birth_place if available",
            "Clear text",
            "Found in personal info"
        ]
    },
    
    "birth_state_province": {
        "description": "State or Province of birth",
        "examples": ["California", "CA", "New York", "NY", "Ontario", "ON", "Texas"],
        "format": "Full state name or 2-letter abbreviation",
        "extraction_hints": [
            "Look for 'Birth State', 'State/Province of Birth', 'State' labels",
            "May be full name or 2-letter abbreviation",
            "Extract from birth_place if combined field",
            "Usually follows city in address format",
            "Check for both full names and abbreviations"
        ],
        "confidence_factors": [
            "Valid state/province name or abbreviation",
            "Consistent with birth_place and birth_city",
            "Standard formatting",
            "Found in personal info"
        ]
    },
    
    "birth_country": {
        "description": "Country of birth",
        "examples": ["USA", "United States", "Canada", "United Kingdom", "Mexico", "India"],
        "format": "Full country name or standard abbreviation (USA, UK, etc.)",
        "extraction_hints": [
            "Look for 'Birth Country', 'Country of Birth', 'Country' labels",
            "May be full name (United States) or abbreviation (USA)",
            "Extract from birth_place if combined field",
            "Usually last component in full birth place",
            "Accept common variations (US, USA, United States)"
        ],
        "confidence_factors": [
            "Valid country name",
            "Consistent with birth_place",
            "Standard country format",
            "Found in personal info"
        ]
    },
    
    "citizenship": {
        "description": "Citizenship/Nationality status",
        "examples": ["US Citizen", "USA", "Canadian", "Permanent Resident", "Naturalized Citizen"],
        "format": "Country name or citizenship status",
        "extraction_hints": [
            "Look for 'Citizenship', 'Nationality', 'Citizen of', 'Status' labels",
            "May indicate status: 'US Citizen', 'Permanent Resident', 'Naturalized'",
            "Different from birth country (naturalization possible)",
            "May be checkbox field or written text",
            "Sometimes in immigration/status section"
        ],
        "confidence_factors": [
            "Valid citizenship status",
            "Standard format",
            "Clear indication of status",
            "Found in personal or legal section"
        ]
    },
    
    "degree": {
        "description": "Highest educational degree in medicine/healthcare",
        "examples": ["MD", "DO", "MBBS", "PhD", "DDS", "PharmD", "RN", "PA", "NP"],
        "format": "Degree abbreviation or full name",
        "extraction_hints": [
            "Look for 'Degree', 'Education', 'Qualification', 'Professional Degree' labels",
            "Common medical degrees: MD, DO, MBBS, DDS, PharmD",
            "Allied health: RN, PA, NP, BSN, MSN",
            "May appear after name with comma (John Doe, MD)",
            "Check education section or credentials area"
        ],
        "confidence_factors": [
            "Valid medical/healthcare degree",
            "Standard abbreviation format",
            "Matches professional context",
            "Found in education or credentials section"
        ]
    },
    
    "gender": {
        "description": "Gender/Sex of individual",
        "examples": ["Male", "Female", "M", "F"],
        "format": "Male/Female or M/F",
        "extraction_hints": [
            "Look for 'Gender', 'Sex', 'M/F', checkboxes",
            "May be checkbox, single letter, or full word",
            "Standardize to full word if possible (M→Male, F→Female)",
            "Usually in personal information section",
            "May be indicated by checked box or circled option"
        ],
        "confidence_factors": [
            "Clear indication of gender",
            "Standard format (Male/Female or M/F)",
            "Found in personal info section",
            "Unambiguous value"
        ]
    },
    
    "ssn": {
        "description": "Social Security Number (often partially masked for privacy)",
        "examples": ["XXX-XX-1234", "1234", "***-**-1234", "SSN: 1234"],
        "format": "Usually last 4 digits only: XXXX or full: XXX-XX-XXXX",
        "extraction_hints": [
            "Look for 'SSN', 'Social Security', 'SS#', 'SSN#' labels",
            "Often only last 4 digits shown for privacy (****-1234)",
            "Format: XXX-XX-XXXX or just last 4 digits",
            "Handle masked values (***-**-1234 or XXX-XX-1234)",
            "May be fully masked with only last 4 visible"
        ],
        "confidence_factors": [
            "Correct format (full or last 4)",
            "Found in personal/identification section",
            "Clear digits (not corrupted)",
            "Proper masking if applicable"
        ]
    },
    
    # =========================================================================
    # STATE LICENSES (MULTIPLE SUPPORTED)
    # =========================================================================
    
    "state_licenses": {
        "description": "State medical/professional licenses - CAN BE MULTIPLE",
        "examples": [
            [{"license_number": "A12345", "state": "CA", "issue_date": "01/15/2020", "expiration_date": "12/31/2025"}],
            [
                {"license_number": "MD123456", "state": "NY", "issue_date": "03/20/2019", "expiration_date": "03/31/2026"},
                {"license_number": "TX-789012", "state": "TX", "issue_date": "06/10/2021", "expiration_date": "06/30/2025"}
            ]
        ],
        "format": "JSON array of objects, each with: license_number, state, issue_date, expiration_date",
        "extraction_hints": [
            "Look in 'State License', 'Medical License', 'Professional License' sections",
            "IMPORTANT: Provider may have MULTIPLE state licenses (multi-state practice)",
            "Extract ALL state licenses found in the document",
            "Each license must have: license_number, state, issue_date, expiration_date",
            "Format dates as MM/DD/YYYY",
            "If issue_date not found, use 'NA' for that field only",
            "License numbers vary by state (letters, numbers, hyphens)",
            "Return as JSON array: [{license1}, {license2}, ...]",
            "If no licenses found, return empty array: []"
        ],
        "confidence_factors": [
            "Found in license section",
            "Has all required fields (number, state, dates)",
            "Dates are valid and logical (issue < expiration)",
            "State is valid US state abbreviation"
        ]
    },
    
    # =========================================================================
    # DEA LICENSES (MULTIPLE SUPPORTED)
    # =========================================================================
    
    "dea_licenses": {
        "description": "DEA (Drug Enforcement Administration) registrations - CAN BE MULTIPLE",
        "examples": [
            [{"license_number": "AB1234563", "state": "CA", "issue_date": "06/01/2023", "expiration_date": "06/30/2026"}],
            [
                {"license_number": "FD1234567", "state": "NY", "issue_date": "01/15/2024", "expiration_date": "01/31/2027"},
                {"license_number": "FB9876543", "state": "TX", "issue_date": "03/10/2023", "expiration_date": "03/31/2026"}
            ]
        ],
        "format": "JSON array of objects, each with: license_number, state, issue_date, expiration_date",
        "extraction_hints": [
            "Look in 'DEA License', 'DEA Registration', 'DEA #' sections",
            "IMPORTANT: Provider may have MULTIPLE DEA licenses (one per state/location)",
            "Extract ALL DEA licenses found in the document",
            "Each license must have: license_number, state, issue_date, expiration_date",
            "DEA number format: 2 letters + 7 digits (9 characters total)",
            "First letter: A=pharmacy, B=hospital, F=practitioner, M=mid-level",
            "Format dates as MM/DD/YYYY",
            "If issue_date not found, use 'NA' for that field only",
            "DEA renewals typically every 3 years",
            "Return as JSON array: [{dea1}, {dea2}, ...]",
            "If no DEA licenses found, return empty array: []"
        ],
        "confidence_factors": [
            "Exactly 9 characters (2 letters + 7 digits)",
            "Found in DEA section",
            "Has all required fields (number, state, dates)",
            "Dates are valid (issue < expiration, ~3 year renewal)"
        ]
    },
    
    # =========================================================================
    # CDS LICENSES (MULTIPLE SUPPORTED)
    # =========================================================================
    
    "cds_licenses": {
        "description": "CDS (Controlled Dangerous Substances) state licenses - CAN BE MULTIPLE",
        "examples": [
            [{"license_number": "CDS123456", "state": "MD", "issue_date": "02/15/2022", "expiration_date": "12/31/2025"}],
            [
                {"license_number": "123456-CDS", "state": "NJ", "issue_date": "05/20/2021", "expiration_date": "05/31/2024"},
                {"license_number": "C-123456", "state": "TX", "issue_date": "08/10/2022", "expiration_date": "08/31/2025"}
            ]
        ],
        "format": "JSON array of objects, each with: license_number, state, issue_date, expiration_date",
        "extraction_hints": [
            "Look in 'CDS License', 'Controlled Substances', 'CDS Registration' sections",
            "IMPORTANT: Provider may have MULTIPLE CDS licenses (one per state)",
            "Extract ALL CDS licenses found in the document",
            "Each license must have: license_number, state, issue_date, expiration_date",
            "State-level license for prescribing controlled substances",
            "Format varies by state (alphanumeric, hyphens)",
            "Format dates as MM/DD/YYYY",
            "If issue_date not found, use 'NA' for that field only",
            "Common in: Maryland (MD), New Jersey (NJ), Texas (TX), Illinois (IL)",
            "Some states don't require separate CDS (use DEA only)",
            "Return as JSON array: [{cds1}, {cds2}, ...]",
            "If no CDS licenses found, return empty array: []"
        ],
        "confidence_factors": [
            "Found in CDS/controlled substances section",
            "Has all required fields (number, state, dates)",
            "State is known to require CDS licenses",
            "Dates are valid (issue < expiration)"
        ]
    },
    
    # =========================================================================
    # OTHER CREDENTIALS
    # =========================================================================
    
    "other_credential_type": {
        "description": "Type of additional credential, certification, or qualification",
        "examples": ["ACLS", "BLS", "PALS", "NRP", "ATLS", "Board Certified", "Fellow"],
        "format": "Credential name or abbreviation",
        "extraction_hints": [
            "Look in 'Other Credentials', 'Certifications', 'Additional Licenses' sections",
            "Common life support: ACLS, BLS, PALS, NRP, ATLS",
            "Specialty: Board Certification, Fellowship",
            "Hospital privileges, teaching credentials",
            "List primary/most important if multiple present"
        ],
        "confidence_factors": [
            "Recognized credential name",
            "Found in credentials/certifications section",
            "Standard abbreviation or full name",
            "Medical/healthcare related"
        ]
    },
    
    "other_credential_state": {
        "description": "State or jurisdiction for additional credential (if applicable)",
        "examples": ["CA", "National", "NY", "Multi-State", "AHA", "N/A"],
        "format": "State abbreviation, 'National', 'Multi-State', or certifying body",
        "extraction_hints": [
            "Many credentials are national (ACLS, BLS from AHA)",
            "Some are state-specific or regional",
            "May say 'National', 'All States', 'AHA', 'ACEP'",
            "For board certifications: often 'National' or certifying board",
            "Use 'NA' if not applicable or not specified"
        ],
        "confidence_factors": [
            "Valid jurisdiction indicator",
            "Consistent with credential type",
            "Found in credentials section",
            "Standard format"
        ]
    },
    
    "other_credential_expiration": {
        "description": "Expiration date of additional credential",
        "examples": ["03/31/2025", "2025-03-31", "March 31, 2025"],
        "format": "MM/DD/YYYY or YYYY-MM-DD",
        "extraction_hints": [
            "Life support certs (ACLS, BLS, PALS) expire every 2 years",
            "Board certifications expire every 5-10 years (or continuous)",
            "Convert to consistent format: MM/DD/YYYY",
            "Some credentials don't expire (use 'NA')",
            "Check 'Valid Until', 'Expires', 'Renewal Date'"
        ],
        "confidence_factors": [
            "Valid future date",
            "Reasonable for credential type",
            "Found in credentials section",
            "Standard date format"
        ]
    },
    
    # =========================================================================
    # BOARD CERTIFICATION
    # =========================================================================
    
    "board_cert_name": {
        "description": "Name of board certification organization",
        "examples": [
            "American Board of Internal Medicine", "ABIM",
            "American Board of Surgery", "ABS",
            "American Board of Family Medicine", "ABFM",
            "American Board of Pediatrics"
        ],
        "format": "Full board name or standard abbreviation",
        "extraction_hints": [
            "Look in 'Board Certification', 'Board Certified', 'Specialty Board' section",
            "Usually starts with 'American Board of...'",
            "Common abbreviations: ABIM, ABS, ABFM, ABP, ABEM",
            "Indicates specialist certification beyond basic license",
            "Separate from other credentials and licenses"
        ],
        "confidence_factors": [
            "Recognized board name",
            "Found in board certification section",
            "Standard format or abbreviation",
            "Medical specialty board"
        ]
    },
    
    "board_cert_specialty": {
        "description": "Medical specialty in which provider is board certified",
        "examples": [
            "Internal Medicine", "Surgery", "Family Medicine",
            "Pediatrics", "Emergency Medicine", "Anesthesiology",
            "Cardiology", "Gastroenterology"
        ],
        "format": "Specialty name (may include subspecialty)",
        "extraction_hints": [
            "Look in 'Board Certification' section under 'Specialty', 'Field'",
            "Primary specialties: Internal Medicine, Surgery, Pediatrics, Family Medicine",
            "Subspecialties: Cardiology (under IM), Trauma Surgery (under Surgery)",
            "May list multiple if dual certified (use primary)",
            "Should align with board_cert_name"
        ],
        "confidence_factors": [
            "Valid medical specialty name",
            "Matches certifying board",
            "Found in board certification section",
            "Standard specialty nomenclature"
        ]
    }
}

# =============================================================================
# SYSTEM PROMPT CONFIGURATION
# =============================================================================

SYSTEM_PROMPT_CONFIG = {
    "role": "You are an expert medical credentialing specialist with years of experience extracting information from healthcare provider documents. You have deep knowledge of medical licenses, DEA registrations, CDS permits, board certifications, and credential verification.",
    
    "extraction_rules": [
        "Extract EXACTLY what you see in the document - do not infer or guess",
        "If a field is not present or cannot be found with confidence, use 'NA'",
        "For dates, convert to MM/DD/YYYY format when possible",
        "For states, you may use either full name or 2-letter abbreviation",
        "Preserve original formatting for license numbers (letters, numbers, hyphens)",
        "Return 'NA' for ANY field you cannot find or are uncertain about (confidence < 0.50)",
        "Do not leave any field empty - use 'NA' for missing values",
        "IMPORTANT: For email, ONLY extract company/professional emails - IGNORE personal emails (gmail, yahoo, hotmail, outlook)",
        "CRITICAL: state_licenses, dea_licenses, cds_licenses are ARRAYS - extract ALL licenses found",
        "Each license object MUST have: license_number, state, issue_date, expiration_date",
        "If issue_date not found, use 'NA' for that field but include other fields",
        "Multiple licenses are COMMON for multi-state practice - extract ALL"
    ],
    
    "confidence_guide": {
        "0.95-1.00": "Exact match found, clear and unambiguous, properly labeled",
        "0.85-0.94": "Strong match, minor formatting differences, clear context",
        "0.70-0.84": "Likely match, some interpretation needed, reasonable confidence",
        "0.50-0.69": "Possible match, moderate uncertainty, ambiguous context",
        "below 0.50": "Field not found or too uncertain - MUST use 'NA'"
    },
    
    "output_format": """
Return a JSON object with ALL configured fields. For each field provide:

SIMPLE FIELDS (string values):
{
  "first_name": {"value": "John", "confidence": 0.95},
  "email": {"value": "john@mpowerhealth.com", "confidence": 0.90}
}

LICENSE FIELDS (array values):
{
  "state_licenses": {
    "value": [
      {"license_number": "A12345", "state": "CA", "issue_date": "01/15/2020", "expiration_date": "12/31/2025"},
      {"license_number": "NY-67890", "state": "NY", "issue_date": "NA", "expiration_date": "06/30/2026"}
    ],
    "confidence": 0.92
  },
  "dea_licenses": {
    "value": [
      {"license_number": "AB1234563", "state": "CA", "issue_date": "06/01/2023", "expiration_date": "06/30/2026"}
    ],
    "confidence": 0.95
  },
  "cds_licenses": {
    "value": [],
    "confidence": 0.50
  }
}

CRITICAL RULES:
- Return 'NA' with confidence 0.50 for simple fields not found
- Return empty array [] for license fields not found
- ALL configured fields MUST be present in response
- Dates in MM/DD/YYYY format
- Email MUST be company domain (not personal)
- Extract ALL licenses (multiple are common)
""",
    
    "restrictions": "Return ONLY the JSON object. No additional text, explanations, preamble, or markdown formatting (no ```json tags)."
}

# =============================================================================
# HELPER FUNCTIONS
# =============================================================================

def get_field_count():
    """Get current number of fields (dynamic)"""
    return len(FIELD_LIBRARY)

def validate_fields():
    """Validate all fields in FIELD_LIBRARY"""
    all_valid = True
    for field_name, field_config in FIELD_LIBRARY.items():
        required_keys = ['description', 'examples', 'format', 'extraction_hints', 'confidence_factors']
        missing_keys = [k for k in required_keys if k not in field_config]
        
        if missing_keys:
            print(f"❌ Field '{field_name}' missing: {missing_keys}")
            all_valid = False
    
    field_count = get_field_count()
    if all_valid:
        print(f"✅ All {field_count} fields defined correctly")
    
    return all_valid

def get_field_names():
    """Get list of all field names (for config.json)"""
    return list(FIELD_LIBRARY.keys())

if __name__ == "__main__":
    print("="*80)
    print("UPDATED FIELD LIBRARY - VALIDATION")
    print("="*80)
    
    is_valid = validate_fields()
    
    if is_valid:
        print("\n" + "="*80)
        print("KEY CHANGES:")
        print("="*80)
        print("1. ✅ Email: Company domain ONLY (no gmail, yahoo, etc)")
        print("2. ✅ State Licenses: ARRAY with issue_date + expiration_date")
        print("3. ✅ DEA Licenses: ARRAY with issue_date + expiration_date")
        print("4. ✅ CDS Licenses: ARRAY with issue_date + expiration_date")
        print("\n✅ Field library is ready with all updates!")
    else:
        print("\n❌ Validation failed!")




  -------

  "extraction": {
    "fields": [
      "first_name",
      "last_name",
      "email",
      "cell",
      "birth_date",
      "birth_place",
      "birth_city",
      "birth_state_province",
      "birth_country",
      "citizenship",
      "degree",
      "gender",
      "ssn",
      "state_licenses",
      "dea_licenses",
      "cds_licenses",
      "other_credential_type",
      "other_credential_state",
      "other_credential_expiration",
      "board_cert_name",
      "board_cert_specialty"
    ],
    "confidence_threshold": 0.5,
    "min_text_length": 10,
    "na_value": "NA"
  },

  
