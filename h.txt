{
  "document_intelligence": {
    "endpoint": "https://<your-doc-intelligence-resource>.cognitiveservices.azure.com/",
    "api_key": "<your-doc-intelligence-key>",
    "project_name": "custom-doc-classifier",
    "model_id": "custom-classifier-v1"
  },
  "storage": {
    "connection_string": "<your-azure-storage-connection-string>",
    "container_name": "document-training-data"
  },
  "paths": {
    "reference_dir": "reference/",
    "input_dir": "input/",
    "output_dir": "output/",
    "classified_dir": "output/classified/",
    "unclassified_dir": "output/unclassified/",
    "source_dir": "output/source/"
  },
  "runtime": {
    "confidence_threshold": 0.9,
    "auto_retrain": true
  }
}


-----

import os
import json
import fitz  # PyMuPDF
from azure.storage.blob import BlobServiceClient
from azure.core.credentials import AzureKeyCredential
from azure.ai.documentintelligence import (
    DocumentIntelligenceAdministrationClient,
    DocumentIntelligenceClient
)

def load_config(config_path="config.json"):
    with open(config_path, "r") as f:
        return json.load(f)

def ensure_directories(paths):
    for key, path in paths.items():
        if not os.path.exists(path):
            os.makedirs(path, exist_ok=True)

def upload_reference_docs_to_blob(config):
    """Uploads all files in reference_dir to the specified container."""
    conn_str = config["storage"]["connection_string"]
    container_name = config["storage"]["container_name"]
    reference_dir = config["paths"]["reference_dir"]

    blob_service = BlobServiceClient.from_connection_string(conn_str)
    container = blob_service.get_container_client(container_name)
    container.create_container(exist_ok=True)

    for root, _, files in os.walk(reference_dir):
        for file in files:
            file_path = os.path.join(root, file)
            blob_path = os.path.relpath(file_path, reference_dir)
            with open(file_path, "rb") as data:
                container.upload_blob(name=blob_path, data=data, overwrite=True)
    print(f"‚úÖ Uploaded all reference documents to Azure Blob: {container_name}")

def split_pdf_into_pages(pdf_path, output_folder):
    doc = fitz.open(pdf_path)
    page_files = []
    for i, page in enumerate(doc):
        output_path = os.path.join(output_folder, f"{os.path.splitext(os.path.basename(pdf_path))[0]}_page_{i+1}.pdf")
        new_pdf = fitz.open()
        new_pdf.insert_pdf(doc, from_page=i, to_page=i)
        new_pdf.save(output_path)
        new_pdf.close()
        page_files.append(output_path)
    doc.close()
    return page_files

def initialize_clients(config):
    endpoint = config["document_intelligence"]["endpoint"]
    api_key = config["document_intelligence"]["api_key"]
    return (
        DocumentIntelligenceAdministrationClient(endpoint=endpoint, credential=AzureKeyCredential(api_key)),
        DocumentIntelligenceClient(endpoint=endpoint, credential=AzureKeyCredential(api_key))
    )

def check_and_retrain_model(admin_client, config):
    """Triggers retraining if auto_retrain is True."""
    if not config["runtime"]["auto_retrain"]:
        return config["document_intelligence"]["model_id"]

    print("üîÑ Starting (re)training process using reference container...")

    conn_str = config["storage"]["connection_string"]
    container_name = config["storage"]["container_name"]
    model_id = config["document_intelligence"]["model_id"]

    # Training using Azure Blob Container reference
    poller = admin_client.begin_build_document_classifier(
        build_request={
            "classifier_id": model_id,
            "source": {
                "azure_blob_source": {
                    "container_url": f"https://{BlobServiceClient.from_connection_string(conn_str).account_name}.blob.core.windows.net/{container_name}"
                }
            }
        }
    )

    result = poller.result()
    print(f"‚úÖ Model retrained successfully: {result.model_id}")
    return result.model_id

def classify_page(doc_client, config, pdf_path):
    """Classify a single PDF page."""
    with open(pdf_path, "rb") as f:
        poller = doc_client.begin_classify_document(
            model_id=config["document_intelligence"]["model_id"],
            document=f
        )
    result = poller.result()
    
    classifications = []
    for doc in result.documents:
        classifications.append({
            "category": doc.doc_type,
            "confidence": doc.confidence
        })
    return classifications



----

import os
import shutil
from helper import (
    load_config, ensure_directories,
    upload_reference_docs_to_blob, initialize_clients,
    check_and_retrain_model, split_pdf_into_pages, classify_page
)

def process_documents():
    config = load_config()
    paths = config["paths"]
    ensure_directories(paths)

    # Upload reference docs to Azure Blob
    upload_reference_docs_to_blob(config)

    # Initialize clients
    admin_client, doc_client = initialize_clients(config)

    # Check and retrain model if needed
    model_id = check_and_retrain_model(admin_client, config)

    input_dir = paths["input_dir"]
    confidence_threshold = config["runtime"]["confidence_threshold"]

    for file in os.listdir(input_dir):
        if file.lower().endswith(".pdf"):
            pdf_path = os.path.join(input_dir, file)
            print(f"\nüìÑ Processing {file}...")

            # Copy original to output/source
            shutil.copy(pdf_path, paths["source_dir"])

            # Split PDF into individual pages
            page_files = split_pdf_into_pages(pdf_path, paths["output_dir"])

            # Classify each page
            for page_pdf in page_files:
                classifications = classify_page(doc_client, config, page_pdf)
                if not classifications:
                    dest = os.path.join(paths["unclassified_dir"], os.path.basename(page_pdf))
                    shutil.move(page_pdf, dest)
                    continue

                best_class = max(classifications, key=lambda x: x["confidence"])
                category = best_class["category"]
                confidence = best_class["confidence"]

                if confidence >= confidence_threshold:
                    dest_folder = os.path.join(paths["classified_dir"], category)
                    os.makedirs(dest_folder, exist_ok=True)
                    shutil.move(page_pdf, os.path.join(dest_folder, os.path.basename(page_pdf)))
                    print(f"‚úÖ Classified as {category} ({confidence:.2f})")
                else:
                    dest = os.path.join(paths["unclassified_dir"], os.path.basename(page_pdf))
                    shutil.move(page_pdf, dest)
                    print(f"‚ö†Ô∏è Low confidence ({confidence:.2f}), moved to unclassified")

if __name__ == "__main__":
    process_documents()
