import fitz  # PyMuPDF
from PIL import Image
from pathlib import Path
from typing import Optional, List
import io


def pdf_to_single_png(
    pdf_path: str,
    output_folder: str,
    username: str,
    dpi: int = 300,
    spacing: int = 0
) -> str:
    """
    Convert all PDF pages into a single combined PNG image (stacked vertically).
    
    Args:
        pdf_path: Path to the input PDF file
        output_folder: Directory where PNG image will be saved
        username: Username for the output filename
        dpi: Resolution for the output images (default: 300)
        spacing: Pixels of white space between pages (default: 0)
    
    Returns:
        Path to the generated combined PNG file
    
    Example:
        # Convert 100 page PDF to single image: john_100.png
        output = pdf_to_single_png("document.pdf", "output_images", "john")
    """
    # Create output folder if it doesn't exist
    Path(output_folder).mkdir(parents=True, exist_ok=True)
    
    # Open PDF
    pdf_document = fitz.open(pdf_path)
    total_pages = pdf_document.page_count
    
    print(f"Processing {total_pages} pages from PDF...")
    
    # Calculate zoom factor for desired DPI (72 is default PDF DPI)
    zoom = dpi / 72
    mat = fitz.Matrix(zoom, zoom)
    
    # Convert all pages to PIL Images
    page_images = []
    max_width = 0
    total_height = 0
    
    for page_num in range(total_pages):
        page = pdf_document[page_num]
        pix = page.get_pixmap(matrix=mat)
        
        # Convert to PIL Image
        img_data = pix.tobytes("png")
        img = Image.open(io.BytesIO(img_data))
        
        page_images.append(img)
        max_width = max(max_width, img.width)
        total_height += img.height
        
        print(f"Processed page {page_num + 1}/{total_pages}")
    
    pdf_document.close()
    
    # Add spacing between pages
    if spacing > 0:
        total_height += spacing * (total_pages - 1)
    
    # Create combined image
    print(f"\nCombining {total_pages} pages into single image...")
    combined_image = Image.new('RGB', (max_width, total_height), 'white')
    
    # Paste each page
    current_y = 0
    for idx, img in enumerate(page_images):
        # Center the image if it's narrower than max_width
        x_offset = (max_width - img.width) // 2
        combined_image.paste(img, (x_offset, current_y))
        current_y += img.height + spacing
        print(f"Added page {idx + 1}/{total_pages} to combined image")
    
    # Generate output filename: username_totalpages.png
    output_path = Path(output_folder) / f"{username}_{total_pages}.png"
    
    # Save combined image
    combined_image.save(output_path, 'PNG', optimize=True)
    
    print(f"\n✓ Successfully created: {output_path}")
    print(f"  Total pages: {total_pages}")
    print(f"  Image size: {max_width} x {total_height} pixels")
    print(f"  File size: {output_path.stat().st_size / (1024*1024):.2f} MB")
    
    return str(output_path)


# Example usage
if __name__ == "__main__":
    # Example 1: Convert 5 page PDF → john_5.png
    pdf_to_single_png(
        pdf_path="input.pdf",
        output_folder="output_images",
        username="john"
    )
    
    # Example 2: Convert 100 page PDF → john_100.png with spacing
    pdf_to_single_png(
        pdf_path="large_document.pdf",
        output_folder="output_images",
        username="john",
        spacing=20  # 20 pixels white space between pages
    )
    
    # Example 3: High quality conversion
    pdf_to_single_png(
        pdf_path="document.pdf",
        output_folder="output_hd",
        username="john",
        dpi=600  # Higher quality
    )
