import os
import traceback
from azure.core.credentials import AzureKeyCredential
from azure.ai.documentintelligence import DocumentIntelligenceClient
from azure.ai.documentintelligence.models import AnalyzeDocumentRequest
import PyPDF2

# Configuration
INPUT_FOLDER = r"path/to/input/pdfs"  # Use raw string for Windows paths
OUTPUT_BASE_FOLDER = r"path/to/output/classified"  # Use raw string for Windows paths
CONFIDENCE_THRESHOLD = 0.6  # 60% confidence threshold
ENDPOINT = "your_azure_endpoint"
KEY = "your_azure_key"
MODEL_ID = "your_custom_model_id"

# Create DocumentIntelligenceClient
document_intelligence_client = DocumentIntelligenceClient(
    endpoint=ENDPOINT,
    credential=AzureKeyCredential(KEY)
)

# Ensure output folders exist
def setup_output_folders(base_folder):
    folders = {
        'classified': os.path.join(base_folder, "classified"),
        'unclassified': os.path.join(base_folder, "unclassified")
    }
    for folder in folders.values():
        os.makedirs(folder, exist_ok=True)
    return folders

# Extract specific pages from a PDF
def extract_pages(input_path, page_numbers):
    """
    Extract specific pages from a PDF
    
    :param input_path: Path to the source PDF
    :param page_numbers: List of page numbers to extract (1-indexed)
    :return: Path to the new PDF with extracted pages
    """
    try:
        # Read the input PDF
        with open(input_path, 'rb') as file:
            reader = PyPDF2.PdfReader(file)
            writer = PyPDF2.PdfWriter()

            # Add specified pages (adjusting for 0-indexing)
            for page_num in page_numbers:
                writer.add_page(reader.pages[page_num - 1])

            # Create a temporary output path
            output_path = os.path.join(
                os.path.dirname(input_path), 
                f"{os.path.splitext(os.path.basename(input_path))[0]}_extracted_pages.pdf"
            )

            # Write the new PDF
            with open(output_path, 'wb') as output_file:
                writer.write(output_file)

        return output_path
    except Exception as e:
        print(f"Error extracting pages: {e}")
        return None

# Process PDFs with page-level classification
def process_pdf_folder(input_folder, output_base_folder):
    # Setup output folders
    output_folders = setup_output_folders(output_base_folder)
    
    # Logging variables
    stats = {
        'total_files': 0,
        'classified_files': 0,
        'unclassified_files': 0,
        'total_pages_processed': 0,
        'classified_pages': 0,
        'unclassified_pages': 0
    }
    
    # Ensure input folder exists and is accessible
    if not os.path.exists(input_folder):
        print(f"Error: Input folder {input_folder} does not exist!")
        return
    
    # Iterate through all files in the input folder
    for filename in os.listdir(input_folder):
        if filename.lower().endswith('.pdf'):
            stats['total_files'] += 1
            input_path = os.path.join(input_folder, filename)
            
            try:
                # Open the PDF file
                with open(input_path, "rb") as file:
                    # Read PDF to get total page count
                    pdf_reader = PyPDF2.PdfReader(file)
                    total_pages = len(pdf_reader.pages)
                    stats['total_pages_processed'] += total_pages
                
                # Classify each page individually
                classified_pages = []
                unclassified_pages = []
                
                for page_num in range(1, total_pages + 1):
                    # Reset file pointer
                    with open(input_path, "rb") as file:
                        # Begin document classification for this page
                        poller = document_intelligence_client.begin_classify_document(
                            classifier_id=MODEL_ID,
                            body=file
                        )
                    
                    # Get classification result
                    result = poller.result()
                    
                    # Check classification for this page
                    page_classified = False
                    for document in result.documents:
                        if document.confidence >= CONFIDENCE_THRESHOLD:
                            classified_pages.append({
                                'page_num': page_num,
                                'type': document.doc_type.lower().replace(' ', '_'),
                                'confidence': document.confidence
                            })
                            page_classified = True
                            stats['classified_pages'] += 1
                            break
                    
                    # Track unclassified pages
                    if not page_classified:
                        unclassified_pages.append(page_num)
                        stats['unclassified_pages'] += 1
                
                # Process classified pages
                if classified_pages:
                    stats['classified_files'] += 1
                    for class_info in classified_pages:
                        # Create type-specific folder
                        type_folder = os.path.join(output_folders['classified'], class_info['type'])
                        os.makedirs(type_folder, exist_ok=True)
                        
                        # Generate output filename
                        output_filename = (
                            f"{os.path.splitext(filename)[0]}_page{class_info['page_num']}_"
                            f"type_{class_info['type']}_"
                            f"conf_{class_info['confidence']:.2f}.pdf"
                        )
                        output_path = os.path.join(type_folder, output_filename)
                        
                        # Extract and save classified pages
                        extracted_pdf = extract_pages(input_path, [class_info['page_num']])
                        if extracted_pdf:
                            import shutil
                            shutil.move(extracted_pdf, output_path)
                        
                        print(f"Classified Page: {filename} - Page {class_info['page_num']}")
                        print(f"  - Type: {class_info['type']}")
                        print(f"  - Confidence: {class_info['confidence']:.2f}")
                        print(f"  - Output: {output_path}")
                
                # Handle unclassified pages
                if unclassified_pages:
                    stats['unclassified_files'] += 1
                    # Create unclassified PDF with remaining pages
                    unclassified_pdf = extract_pages(input_path, unclassified_pages)
                    if unclassified_pdf:
                        unclassified_output = os.path.join(
                            output_folders['unclassified'], 
                            f"{os.path.splitext(filename)[0]}_unclassified_pages.pdf"
                        )
                        import shutil
                        shutil.move(unclassified_pdf, unclassified_output)
                        print(f"Unclassified Pages: {filename} - Pages {unclassified_pages}")
            
            except FileNotFoundError:
                print(f"Error: File not found - {input_path}")
                print(traceback.format_exc())
                continue
            except Exception as e:
                print(f"Unexpected error processing {filename}: {e}")
                print(traceback.format_exc())
                continue
    
    # Print processing summary
    print("\n--- Processing Summary ---")
    print(f"Total Files: {stats['total_files']}")
    print(f"Classified Files: {stats['classified_files']}")
    print(f"Unclassified Files: {stats['unclassified_files']}")
    print(f"Total Pages Processed: {stats['total_pages_processed']}")
    print(f"Classified Pages: {stats['classified_pages']}")
    print(f"Unclassified Pages: {stats['unclassified_pages']}")

# Run the processing
process_pdf_folder(INPUT_FOLDER, OUTPUT_BASE_FOLDER)
```

Key Improvements:

1. Robust Error Handling
   - Uses `traceback` to provide detailed error information
   - Handles `FileNotFoundError` and other exceptions
   - Continues processing even if individual files fail

2. Page-Level Classification
   - Classifies each page individually
   - Supports partial document classification
   - Separates classified and unclassified pages

3. Detailed Folder Structure
```
output_classified/
├── classified/
│   ├── invoice/
│   │   ├── doc1_page2_type_invoice_conf_0.85.pdf
│   │   └── doc1_page4_type_invoice_conf_0.72.pdf
│   └── receipt/
│       └── doc2_page3_type_receipt_conf_0.65.pdf
└── unclassified/
    ├── doc1_unclassified_pages.pdf  # Contains pages 1, 3, 5
    └── doc2_unclassified_pages.pdf
