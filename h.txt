#classify_docs.py

from PyPDF2 import PdfReader, PdfWriter
import tempfile, os, shutil
from azure.ai.documentintelligence import DocumentIntelligenceClient
from azure.core.credentials import AzureKeyCredential
import json

# Load config
with open("config.json") as f:
    config = json.load(f)

endpoint = config["azure_document_intelligence_endpoint"]
key = config["azure_document_intelligence_key"]
model_id = config["model_id"]

client = DocumentIntelligenceClient(endpoint=endpoint, credential=AzureKeyCredential(key))

input_folder = "input_docs"
output_source = "output/source"
output_classified = "output/classified"

os.makedirs(output_source, exist_ok=True)
os.makedirs(output_classified, exist_ok=True)

def split_pdf(file_path):
    reader = PdfReader(file_path)
    pages = []
    for i, page in enumerate(reader.pages):
        writer = PdfWriter()
        writer.add_page(page)
        temp_file = tempfile.NamedTemporaryFile(delete=False, suffix=f"_page_{i+1}.pdf")
        with open(temp_file.name, "wb") as f:
            writer.write(f)
        pages.append(temp_file.name)
    return pages

for file_name in os.listdir(input_folder):
    if not file_name.lower().endswith(".pdf"):
        continue

    file_path = os.path.join(input_folder, file_name)
    print(f"üìÑ Processing: {file_name}")
    shutil.copy(file_path, output_source)

    # Split PDF pages
    page_files = split_pdf(file_path)

    for page_file in page_files:
        with open(page_file, "rb") as f:
            poller = client.begin_classify_document(model_id=model_id, document=f)
            result = poller.result()

        category = result.documents[0].doc_type if result.documents else "unclassified"
        print(f"‚û°Ô∏è Page {page_file} classified as: {category}")

        dest_folder = os.path.join(output_classified, category)
        os.makedirs(dest_folder, exist_ok=True)

        dest_name = os.path.join(dest_folder, os.path.basename(page_file))
        shutil.copy(page_file, dest_name)
        os.remove(page_file)
-----
  #upload_to_blob.py
  from azure.storage.blob import BlobServiceClient, generate_container_sas, ContainerSasPermissions
from datetime import datetime, timedelta
import os
import json

with open("config.json") as f:
    config = json.load(f)

connect_str = config["azure_storage_connection_string"]
container_name = config["training_container"]
reference_path = "reference"

blob_service_client = BlobServiceClient.from_connection_string(connect_str)
container_client = blob_service_client.get_container_client(container_name)
container_client.upload_blob(name="", data=b"", overwrite=True)

for root, _, files in os.walk(reference_path):
    for file in files:
        full_path = os.path.join(root, file)
        blob_path = os.path.relpath(full_path, reference_path)
        with open(full_path, "rb") as data:
            container_client.upload_blob(blob_path, data, overwrite=True)
        print(f"Uploaded {blob_path}")

# Generate SAS URL valid for 7 days
sas_url = (
    blob_service_client.primary_endpoint
    + "/"
    + container_name
    + "?"
    + generate_container_sas(
        account_name=blob_service_client.account_name,
        container_name=container_name,
        permission=ContainerSasPermissions(read=True, list=True),
        expiry=datetime.utcnow() + timedelta(days=7),
    )
)

print("‚úÖ SAS URL generated:\n", sas_url)

  ----
  train_classifier.py

  import json
from azure.ai.documentintelligence import DocumentIntelligenceAdministrationClient
from azure.core.credentials import AzureKeyCredential

# Load configuration
with open("config.json") as f:
    config = json.load(f)

endpoint = config["azure_document_intelligence_endpoint"]
key = config["azure_document_intelligence_key"]
training_data_sas_url = config["training_data_sas_url"]
model_id = config["model_id"]

# Initialize client
admin_client = DocumentIntelligenceAdministrationClient(endpoint=endpoint, credential=AzureKeyCredential(key))

# Train custom classifier model
poller = admin_client.begin_build_document_classifier(
    build_request={
        "classifier_id": model_id,
        "description": "Unified document classifier (CMS1500, invoice, scheduling, etc.)",
        "doc_types": {
            "cms1500": {"source": f"{training_data_sas_url}/cms1500"},
            "invoice": {"source": f"{training_data_sas_url}/invoice"},
            "scheduling": {"source": f"{training_data_sas_url}/scheduling"}
        }
    }
)
model = poller.result()
print(f"‚úÖ Model '{model.model_id}' trained successfully!")

  ------------------
  #config.json
{
  "azure_document_intelligence_endpoint": "https://<your-region>.api.cognitive.microsoft.com/",
  "azure_document_intelligence_key": "<your-key>",
  "project_name": "unified-doc-classifier",
  "training_data_sas_url": "<sas-url-to-reference-folder>",
  "model_id": "unified_classifier_model_v1"
}

