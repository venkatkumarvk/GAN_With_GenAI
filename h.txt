import pyodbc

def log_file_status_begin(filename, source_path, target_path, archive_path, status_desc, config):
    """
    Logs BEGIN status and returns the SQL-generated document_id.
    """
    try:
        conn_str = config["sql_server"]["connection_string"]
        conn = pyodbc.connect(conn_str)
        cur = conn.cursor()

        result = cur.execute(
            "{CALL dbo.uspXUpdateDocumentProcessor (?, ?, ?, ?, ?, ?, ?)}",
            None, filename, source_path, target_path, archive_path, "BEGIN", status_desc
        ).fetchone()

        document_id = result[0] if result else None

        cur.close()
        conn.close()
        return document_id

    except Exception as e:
        print(f"[SQL LOGGING ERROR - BEGIN] {e}")
        return None


def log_file_status_update(document_id, filename, source_path, target_path, archive_path, status, status_desc, config):
    """
    Updates an existing log row in SQL using the document_id.
    """
    if not document_id:
        print("[SQL UPDATE ERROR] document_id is missing")
        return False

    try:
        conn_str = config["sql_server"]["connection_string"]
        conn = pyodbc.connect(conn_str)
        cur = conn.cursor()

        cur.execute(
            "{CALL dbo.uspXUpdateDocumentProcessor (?, ?, ?, ?, ?, ?, ?)}",
            document_id, filename, source_path, target_path, archive_path, status, status_desc
        )

        conn.commit()
        cur.close()
        conn.close()
        return True

    except Exception as e:
        print(f"[SQL LOGGING ERROR - UPDATE] {e}")
        return False
