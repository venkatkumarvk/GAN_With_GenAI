import os
import re
import shutil
import logging
import traceback
from datetime import datetime
from azure.core.credentials import AzureKeyCredential
from azure.ai.documentintelligence import DocumentIntelligenceClient
from azure.ai.documentintelligence.models import AnalyzeDocumentRequest
import PyPDF2

# Configuration
INPUT_FOLDER = r"path/to/input/pdfs"  # Input PDF folder
OUTPUT_BASE_FOLDER = r"path/to/output"  # Base output folder
CONFIDENCE_THRESHOLD = 0.6  # 60% confidence threshold
ENDPOINT = "your_azure_endpoint"
KEY = "your_azure_key"
MODEL_ID = "your_custom_model_id"

# Setup logging
log_filename = f'document_classification_{datetime.now().strftime("%Y%m%d_%H%M%S")}.log'
logging.basicConfig(
    filename=log_filename,
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s: %(message)s'
)

# Create DocumentIntelligenceClient
document_intelligence_client = DocumentIntelligenceClient(
    endpoint=ENDPOINT,
    credential=AzureKeyCredential(KEY)
)

# Setup output folders
def setup_output_folders(base_folder):
    """
    Create source, classified, and unclassified folders
    """
    folders = {
        'source': os.path.join(base_folder, 'source'),
        'classified': os.path.join(base_folder, 'classified'),
        'unclassified': os.path.join(base_folder, 'unclassified')
    }
    
    # Create folders
    for folder in folders.values():
        os.makedirs(folder, exist_ok=True)
    
    return folders

# Sanitize filename
def sanitize_filename(filename):
    """
    Sanitize filename to remove problematic characters
    """
    # Replace or remove problematic characters
    filename = re.sub(r'[<>:"/\\|?*]', '_', filename)
    # Remove leading/trailing spaces and periods
    filename = filename.strip('. ')
    return filename

# Extract specific pages from a PDF
def extract_pages(input_path, page_numbers):
    """
    Extract specific pages from a PDF
    
    :param input_path: Path to the source PDF
    :param page_numbers: List of page numbers to extract (1-indexed)
    :return: Path to the new PDF with extracted pages
    """
    try:
        # Read the input PDF
        with open(input_path, 'rb') as file:
            reader = PyPDF2.PdfReader(file)
            writer = PyPDF2.PdfWriter()

            # Add specified pages (adjusting for 0-indexing)
            for page_num in page_numbers:
                writer.add_page(reader.pages[page_num - 1])

            # Create a temporary output path
            output_path = os.path.join(
                os.path.dirname(input_path), 
                f"{os.path.splitext(os.path.basename(input_path))[0]}_extracted_pages.pdf"
            )

            # Write the new PDF
            with open(output_path, 'wb') as output_file:
                writer.write(output_file)

        return output_path
    except Exception as e:
        logging.error(f"Error extracting pages: {e}")
        return None

# Process PDFs with page-level classification
def process_pdf_folder(input_folder, output_base_folder):
    # Setup output folders
    output_folders = setup_output_folders(output_base_folder)
    
    # Logging variables
    stats = {
        'total_files': 0,
        'classified_files': 0,
        'unclassified_files': 0,
        'total_pages_processed': 0,
        'classified_pages': 0,
        'document_types': {}
    }
    
    # Log start of processing
    logging.info(f"Starting document classification")
    logging.info(f"Input Folder: {input_folder}")
    logging.info(f"Output Folder: {output_base_folder}")
    logging.info(f"Confidence Threshold: {CONFIDENCE_THRESHOLD}")
    
    # Ensure input folder exists
    if not os.path.exists(input_folder):
        logging.error(f"Input folder {input_folder} does not exist!")
        return
    
    # Iterate through all files in the input folder
    for filename in os.listdir(input_folder):
        # Process only PDF files
        if filename.lower().endswith('.pdf'):
            try:
                # Increment total files
                stats['total_files'] += 1
                
                # Full input path
                input_path = os.path.join(input_folder, filename)
                
                # Copy source file to source folder
                sanitized_filename = sanitize_filename(filename)
                source_output_path = os.path.join(output_folders['source'], sanitized_filename)
                shutil.copy2(input_path, source_output_path)
                
                # Open the PDF file
                with open(input_path, "rb") as file:
                    # Read PDF to get total page count
                    pdf_reader = PyPDF2.PdfReader(file)
                    total_pages = len(pdf_reader.pages)
                    stats['total_pages_processed'] += total_pages
                
                # Classify each page individually
                classified_page_groups = {}
                
                for page_num in range(1, total_pages + 1):
                    # Reset file pointer
                    with open(input_path, "rb") as file:
                        # Begin document classification for this page
                        poller = document_intelligence_client.begin_classify_document(
                            classifier_id=MODEL_ID,
                            body=file
                        )
                    
                    # Get classification result
                    result = poller.result()
                    
                    # Check classification for this page
                    for document in result.documents:
                        if document.confidence >= CONFIDENCE_THRESHOLD:
                            doc_type = document.doc_type.lower().replace(' ', '_')
                            
                            # Group pages by their document type
                            if doc_type not in classified_page_groups:
                                classified_page_groups[doc_type] = []
                            
                            classified_page_groups[doc_type].append({
                                'page_num': page_num,
                                'confidence': document.confidence
                            })
                            
                            # Update document type stats
                            if doc_type not in stats['document_types']:
                                stats['document_types'][doc_type] = 0
                            stats['document_types'][doc_type] += 1
                            
                            stats['classified_pages'] += 1
                            break
                
                # Process classified pages
                if classified_page_groups:
                    stats['classified_files'] += 1
                    
                    # Process each document type
                    for doc_type, page_info in classified_page_groups.items():
                        # Create type-specific folder in classified output
                        type_output_folder = os.path.join(output_folders['classified'], doc_type)
                        os.makedirs(type_output_folder, exist_ok=True)
                        
                        # Prepare classified page numbers
                        classified_nums = [page['page_num'] for page in page_info]
                        
                        # Extract classified pages
                        extracted_pdf = extract_pages(input_path, classified_nums)
                        
                        if extracted_pdf:
                            # Create output filename
                            output_filename = (
                                f"{os.path.splitext(sanitized_filename)[0]}_"
                                f"pages{'_'.join(map(str, classified_nums))}_"
                                f"classified.pdf"
                            )
                            
                            # Full output path for classified PDF
                            output_path = os.path.join(type_output_folder, output_filename)
                            
                            # Move extracted PDF
                            shutil.move(extracted_pdf, output_path)
                            
                            # Logging
                            logging.info(f"Classified File: {filename}")
                            logging.info(f"  - Document Type: {doc_type}")
                            logging.info(f"  - Classified Pages: {classified_nums}")
                            logging.info(f"  - Output: {output_path}")
                else:
                    # No pages classified - move to unclassified
                    stats['unclassified_files'] += 1
                    
                    # Move to unclassified folder
                    unclassified_output_path = os.path.join(output_folders['unclassified'], sanitized_filename)
                    shutil.copy2(input_path, unclassified_output_path)
                    
                    # Logging
                    logging.info(f"Unclassified File: {filename}")
                    logging.info(f"  - Moved to: {unclassified_output_path}")
                
            except Exception as e:
                logging.error(f"Error processing {filename}: {e}")
                logging.error(traceback.format_exc())
                continue
    
    # Print and log processing summary
    summary_message = f"""
--- Processing Summary ---
Total Files Processed: {stats['total_files']}
Classified Files: {stats['classified_files']}
Unclassified Files: {stats['unclassified_files']}
Total Pages Processed: {stats['total_pages_processed']}
Classified Pages: {stats['classified_pages']}
Document Types:
{chr(10).join(f"  - {doc_type}: {count}" for doc_type, count in stats['document_types'].items())}
"""
    print(summary_message)
    logging.info(summary_message)

# Run the processing
process_pdf_folder(INPUT_FOLDER, OUTPUT_BASE_FOLDER)
```

Output Folder Structure:
```
output/
├── source/
│   ├── original_document1.pdf
│   ├── original_document2.pdf
│   └── ...
│
├── classified/
│   ├── invoice/
│   │   ├── original_document1_pages2_4_invoice_classified.pdf
│   │   └── original_document2_pages6_invoice_classified.pdf
│   │
│   ├── receipt/
│   │   └── original_document3_pages7_receipt_classified.pdf
│   │
│   └── contract/
│       └── original_document4_pages9_contract_classified.pdf
│
└── unclassified/
    ├── original_document5.pdf
    └── ...
