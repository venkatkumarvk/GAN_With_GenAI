import os
import logging
from datetime import datetime
from logging.handlers import RotatingFileHandler
import traceback
import json

class LoggerHelper:
    def __init__(self, name="document_processor", log_dir="logs", log_level=logging.INFO):
        """
        Initialize logger with comprehensive logging capabilities
        
        :param name: Name of the logger
        :param log_dir: Directory to store log files
        :param log_level: Logging level
        """
        # Create logs directory if it doesn't exist
        os.makedirs(log_dir, exist_ok=True)
        
        # Timestamp for log files
        self.timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        
        # Create main logger
        self.logger = logging.getLogger(name)
        self.logger.setLevel(log_level)
        
        # Clear existing handlers to prevent duplicate logs
        self.logger.handlers.clear()
        
        # Console Handler with more detailed format
        console_handler = logging.StreamHandler()
        console_handler.setLevel(log_level)
        console_formatter = logging.Formatter(
            '%(asctime)s | %(levelname)-8s | %(filename)s:%(lineno)d | %(message)s',
            datefmt='%Y-%m-%d %H:%M:%S'
        )
        console_handler.setFormatter(console_formatter)
        self.logger.addHandler(console_handler)
        
        # Main Log File Handler (All Logs)
        main_log_path = os.path.join(log_dir, f"{name}_{self.timestamp}_full.log")
        file_handler = RotatingFileHandler(
            main_log_path, 
            maxBytes=50*1024*1024,  # 50 MB
            backupCount=10
        )
        file_handler.setLevel(log_level)
        file_formatter = logging.Formatter(
            '%(asctime)s | %(levelname)-8s | %(filename)s:%(lineno)d | %(funcName)s | %(message)s',
            datefmt='%Y-%m-%d %H:%M:%S'
        )
        file_handler.setFormatter(file_formatter)
        self.logger.addHandler(file_handler)
        
        # Error Log File Handler
        error_log_path = os.path.join(log_dir, f"{name}_{self.timestamp}_error.log")
        error_handler = RotatingFileHandler(
            error_log_path, 
            maxBytes=50*1024*1024,  # 50 MB
            backupCount=10
        )
        error_handler.setLevel(logging.ERROR)
        error_handler.setFormatter(file_formatter)
        self.logger.addHandler(error_handler)

    def get_logger(self):
        """
        Return the configured logger
        """
        return self.logger

    def log_section_header(self, message):
        """
        Log a section header for better readability
        """
        header = "=" * 80
        self.logger.info(header)
        self.logger.info(f">> {message}")
        self.logger.info(header)

    def log_separator(self):
        """
        Log a separator line
        """
        self.logger.info("-" * 80)

    def log_configuration(self, config):
        """
        Log detailed configuration information
        """
        self.log_section_header("SYSTEM CONFIGURATION")
        
        # Safely convert config to JSON for logging
        try:
            # Mask sensitive information
            masked_config = self._mask_sensitive_config(config)
            config_str = json.dumps(masked_config, indent=2)
            
            # Log configuration
            self.logger.info("Full Configuration:")
            for line in config_str.split('\n'):
                self.logger.info(line)
        except Exception as e:
            self.logger.error(f"Error logging configuration: {e}")
        
        self.log_separator()

    def _mask_sensitive_config(self, config):
        """
        Mask sensitive information in configuration
        """
        masked_config = config.copy()
        
        # List of keys to mask
        sensitive_keys = [
            'api_key', 
            'connection_string', 
            'endpoint', 
            'client_secret', 
            'password'
        ]
        
        def mask_dict(d):
            for key, value in d.items():
                if isinstance(value, dict):
                    d[key] = mask_dict(value)
                elif any(sens_key in key.lower() for sens_key in sensitive_keys):
                    d[key] = '***MASKED***'
            return d
        
        return mask_dict(masked_config)

    def log_exception(self, error, additional_context=None):
        """
        Log detailed exception information
        
        :param error: Exception object
        :param additional_context: Optional additional context information
        """
        self.logger.error("=" * 80)
        self.logger.error("EXCEPTION DETAILS")
        self.logger.error("=" * 80)
        
        self.logger.error(f"Error Type: {type(error).__name__}")
        self.logger.error(f"Error Message: {str(error)}")
        
        # Log traceback
        self.logger.error("Traceback:")
        traceback_lines = traceback.format_exc().split('\n')
        for line in traceback_lines:
            if line.strip():
                self.logger.error(line)
        
        # Log additional context if provided
        if additional_context:
            self.logger.error("Additional Context:")
            if isinstance(additional_context, dict):
                for key, value in additional_context.items():
                    self.logger.error(f"  {key}: {value}")
            else:
                self.logger.error(str(additional_context))
        
        self.logger.error("=" * 80)

def setup_logger(config, log_level=logging.INFO, doc_type=None):
    """
    Set up and configure a logger
    
    :param config: Configuration dictionary
    :param log_level: Logging level (default: INFO)
    :param doc_type: Document type being processed (optional)
    :return: Configured logger
    """
    # Initialize LoggerHelper
    helper = LoggerHelper(
        name="document_processor",
        log_dir="logs",
        log_level=log_level
    )
    
    # Log configuration details
    helper.log_configuration(config)
    
    # Get and return logger
    return helper.get_logger()


import os
import logging
from datetime import datetime

def setup_logging(config):
    """
    Set up logging configuration based on the config
    
    :param config: Configuration dictionary
    """
    # Create logs directory if it doesn't exist
    log_dir = config.get('paths', {}).get('log_dir', 'logs')
    os.makedirs(log_dir, exist_ok=True)

    # Generate log filename with timestamp
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    log_filename = f"document_processing_{timestamp}.log"
    log_file = os.path.join(log_dir, log_filename)

    # Configure logging
    logging.basicConfig(
        level=getattr(logging, config.get('logging', {}).get('level', 'INFO').upper()),
        format='%(asctime)s - %(levelname)s: %(filename)s:%(lineno)d - %(message)s',
        handlers=[
            # File handler to save all logs
            logging.FileHandler(log_file, mode='a'),
            # Console handler to display logs in terminal
            logging.StreamHandler()
        ]
    )

    # Log initial configuration
    logger = logging.getLogger()
    logger.info("Logging initialized")
    logger.info(f"Log file created: {log_file}")

    return logger
