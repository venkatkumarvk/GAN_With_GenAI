def load_config_with_keyvault(config_path):
    """
    Load configuration file and replace Azure Key Vault placeholders
    
    :param config_path: Path to the configuration file
    :return: Processed configuration dictionary
    """
    try:
        # Read the configuration file
        with open(config_path, 'r') as f:
            original_config = json.load(f)
        
        # Create a deep copy of the original config to modify
        config = json.loads(json.dumps(original_config))
        
        # Check if Azure Key Vault configuration exists
        if 'azure_keyvault' not in config:
            return original_config
        
        # Initialize Azure Key Vault client
        keyvault_url = config['azure_keyvault'].get('vault_url')
        if not keyvault_url:
            logging.warning("Azure Key Vault URL not provided")
            return original_config
        
        keyvault_manager = AzureKeyVaultManager(keyvault_url)
        
        # Recursively process the configuration
        def process_config(obj):
            if isinstance(obj, dict):
                for key, value in list(obj.items()):
                    if isinstance(value, str) and value.startswith('@azurekeyvault(') and value.endswith(')'):
                        # Extract secret name
                        secret_name = value[len('@azurekeyvault('):-1]
                        try:
                            # Retrieve secret from Azure Key Vault
                            obj[key] = keyvault_manager.get_secret(secret_name)
                        except Exception as e:
                            logging.error(f"Failed to retrieve secret {secret_name}: {e}")
                            # Keep the original value if retrieval fails
                    elif isinstance(value, (dict, list)):
                        process_config(value)
            elif isinstance(obj, list):
                for i, item in enumerate(obj):
                    if isinstance(item, (dict, list)):
                        process_config(item)
        
        # Process the configuration
        process_config(config)
        
        # Return the original config with Key Vault secrets replaced
        return config
    
    except Exception as e:
        logging.error(f"Error loading configuration with Key Vault: {e}")
        # Fallback to original config loading
        with open(config_path, 'r') as f:
            return json.load(f)



----


import json
import logging
import os
from azure_keyvault import load_config_with_keyvault

def setup_logging(config):
    """
    Configure logging based on configuration
    
    :param config: Configuration dictionary
    """
    try:
        # Default logging configuration
        log_level = getattr(logging, config.get('logging', {}).get('level', 'INFO').upper())
        log_format = config.get('logging', {}).get('format', 
            '%(asctime)s - %(name)s - %(levelname)s - %(message)s')
        
        # Ensure log directory exists
        log_dir = config.get('paths', {}).get('log_dir', 'logs')
        os.makedirs(log_dir, exist_ok=True)
        
        # Log file path
        log_file = os.path.join(log_dir, 
            config.get('logging', {}).get('file', 'application.log'))
        
        # Configure logging
        logging.basicConfig(
            level=log_level,
            format=log_format,
            handlers=[
                logging.FileHandler(log_file),
                logging.StreamHandler()
            ]
        )
        
        logging.info("Logging configured successfully")
    
    except Exception as e:
        # Fallback to basic logging configuration
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
        )
        logging.error(f"Error configuring logging: {e}")

def load_config(config_path):
    """
    Load configuration file with Azure Key Vault support
    
    :param config_path: Path to the configuration file
    :return: Processed configuration dictionary
    """
    try:
        # Use the new Key Vault-aware configuration loader
        config = load_config_with_keyvault(config_path)
        return config
    except Exception as e:
        logging.error(f"Failed to load configuration: {e}")
        # Fallback to standard JSON loading
        with open(config_path, 'r') as f:
            return json.load(f)


