import os
import logging
from datetime import datetime
from logging.handlers import RotatingFileHandler
import traceback

class LoggerHelper:
    def __init__(self, name="document_processor", log_dir="logs", log_level=logging.INFO):
        """
        Initialize logger with comprehensive logging capabilities
        
        :param name: Name of the logger
        :param log_dir: Directory to store log files
        :param log_level: Logging level
        """
        # Create logs directory if it doesn't exist
        os.makedirs(log_dir, exist_ok=True)
        
        # Timestamp for log files
        self.timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        
        # Create main logger
        self.logger = logging.getLogger(name)
        self.logger.setLevel(log_level)
        
        # Prevent duplicate handlers
        if not self.logger.handlers:
            # Console Handler
            console_handler = logging.StreamHandler()
            console_handler.setLevel(log_level)
            console_formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
            console_handler.setFormatter(console_formatter)
            self.logger.addHandler(console_handler)
            
            # Main Log File Handler (All Logs)
            main_log_path = os.path.join(log_dir, f"{name}_{self.timestamp}_full.log")
            file_handler = RotatingFileHandler(
                main_log_path, 
                maxBytes=10*1024*1024,  # 10 MB
                backupCount=5
            )
            file_handler.setLevel(log_level)
            file_formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(filename)s:%(lineno)d - %(message)s')
            file_handler.setFormatter(file_formatter)
            self.logger.addHandler(file_handler)
            
            # Error Log File Handler
            error_log_path = os.path.join(log_dir, f"{name}_{self.timestamp}_error.log")
            error_handler = RotatingFileHandler(
                error_log_path, 
                maxBytes=10*1024*1024,  # 10 MB
                backupCount=5
            )
            error_handler.setLevel(logging.ERROR)
            error_handler.setFormatter(file_formatter)
            self.logger.addHandler(error_handler)

    def get_logger(self):
        """
        Return the configured logger
        """
        return self.logger

    def log_section_header(self, message):
        """
        Log a section header for better readability
        """
        header = "=" * 50
        self.logger.info(header)
        self.logger.info(message)
        self.logger.info(header)

    def log_separator(self):
        """
        Log a separator line
        """
        self.logger.info("-" * 50)

    def log_configuration(self, config):
        """
        Log detailed configuration information
        """
        # Log configuration details similar to your previous example
        self.log_section_header("Configuration Details")
        
        # Log Azure OpenAI configuration
        if 'azure_openai' in config:
            self.logger.info("Azure OpenAI Configuration:")
            openai_config = config['azure_openai']
            self.logger.info(f"  Endpoint: {openai_config.get('endpoint')}")
            self.logger.info(f"  Deployment: {openai_config.get('deployment_name')}")
            self.logger.info(f"  API Version: {openai_config.get('api_version')}")

        # Log storage configuration
        if 'azure_storage' in config:
            self.logger.info("Azure Storage Configuration:")
            storage_config = config['azure_storage']
            self.logger.info(f"  Input Container: {storage_config.get('input_container')}")
            self.logger.info(f"  Output Container: {storage_config.get('output_container')}")

        # Log classification configuration
        if 'classification' in config:
            self.logger.info("Classification Configuration:")
            class_config = config['classification']
            self.logger.info(f"  Confidence Threshold: {class_config.get('confidence_threshold')}")
            self.logger.info(f"  Batch Size: {class_config.get('batch_size')}")

        self.log_separator()

    def log_exception(self, error, additional_context=None):
        """
        Log detailed exception information
        
        :param error: Exception object
        :param additional_context: Optional additional context information
        """
        self.logger.error("Exception Occurred:")
        self.logger.error(f"Error Type: {type(error).__name__}")
        self.logger.error(f"Error Message: {str(error)}")
        
        # Log traceback
        self.logger.error("Traceback:")
        traceback_lines = traceback.format_exc().split('\n')
        for line in traceback_lines:
            if line.strip():
                self.logger.error(line)
        
        # Log additional context if provided
        if additional_context:
            self.logger.error("Additional Context:")
            if isinstance(additional_context, dict):
                for key, value in additional_context.items():
                    self.logger.error(f"  {key}: {value}")
            else:
                self.logger.error(str(additional_context))

def setup_logger(config, log_level=logging.INFO, doc_type=None):
    """
    Set up and configure a logger
    
    :param config: Configuration dictionary
    :param log_level: Logging level (default: INFO)
    :param doc_type: Document type being processed (optional)
    :return: Configured logger
    """
    # Initialize LoggerHelper
    helper = LoggerHelper(
        name="document_processor",
        log_dir="logs",
        log_level=log_level
    )
    
    # Log configuration details
    helper.log_configuration(config)
    
    # Get and return logger
    return helper.get_logger()



-----
import logging
from logger_helper import setup_logger

# In your main processing script
logger = setup_logger(config)

# Use logging as before
logger.info("Processing started")
logger.error("An error occurred")


----

# In azure_keyvault.py, helper.py, etc.
import logging

# This will use the same logger setup
logger = logging.getLogger("document_processor")

