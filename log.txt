import os
import logging
from datetime import datetime

def setup_logging(config, doc_type=None):
    """
    Set up logging configuration based on the config
    
    :param config: Configuration dictionary
    :param doc_type: Optional document type for specific logging
    """
    # Create logs directory if it doesn't exist
    log_dir = config.get('paths', {}).get('log_dir', 'logs')
    os.makedirs(log_dir, exist_ok=True)

    # Generate log filename with timestamp
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    log_filename = f"document_processing_{timestamp}.log"
    log_file = os.path.join(log_dir, log_filename)

    # Configure logging
    logging.basicConfig(
        level=getattr(logging, config.get('logging', {}).get('level', 'INFO').upper()),
        format='%(asctime)s - %(levelname)s: %(filename)s:%(lineno)d - %(message)s',
        handlers=[
            # File handler to save all logs
            logging.FileHandler(log_file, mode='a'),
            # Console handler to display logs in terminal
            logging.StreamHandler()
        ]
    )

    # Get logger
    logger = logging.getLogger()
    
    # Log initial configuration
    logger.info("Logging initialized")
    logger.info(f"Log file created: {log_file}")

    # Log system configuration details
    logger.info("=" * 50)
    logger.info("SYSTEM CONFIGURATION")
    logger.info("=" * 50)

    # Azure OpenAI configuration
    logger.info("Azure OpenAI Configuration:")
    try:
        openai_config = config.get('azure_openai', {})
        logger.info(f"  API Version: {openai_config.get('api_version', 'Not specified')}")
        logger.info(f"  Endpoint: {openai_config.get('endpoint', 'Not specified')}")
        logger.info(f"  Deployment Name: {openai_config.get('deployment_name', 'Not specified')}")
    except Exception as e:
        logger.error(f"Error logging Azure OpenAI configuration: {e}")

    # Processing configuration
    logger.info("\nProcessing Configuration:")
    try:
        processing_config = config.get('classification', {})
        logger.info(f"  Confidence Threshold: {processing_config.get('confidence_threshold', 'Not specified')}%")
        logger.info(f"  Batch Size: {processing_config.get('batch_size', 'Not specified')}")
    except Exception as e:
        logger.error(f"Error logging processing configuration: {e}")

    # Storage configuration
    logger.info("\nStorage Configuration:")
    try:
        storage_config = config.get('azure_storage', {})
        logger.info(f"  Input Container: {storage_config.get('input_container', 'Not specified')}")
        logger.info(f"  Output Container: {storage_config.get('output_container', 'Not specified')}")
    except Exception as e:
        logger.error(f"Error logging storage configuration: {e}")

    # Categories configuration
    logger.info("\nDocument Categories:")
    try:
        categories = config.get('categories', {})
        for main_category, subcategories in categories.items():
            logger.info(f"  {main_category.upper()}: {', '.join(subcategories)}")
    except Exception as e:
        logger.error(f"Error logging categories: {e}")

    # Batch processing configuration
    logger.info("\nBatch Processing Configuration:")
    try:
        batch_config = config.get('batch_config', {})
        logger.info(f"  Input Container: {batch_config.get('input_container', 'Not specified')}")
        logger.info(f"  Output Container: {batch_config.get('output_container', 'Not specified')}")
        logger.info(f"  Polling Interval: {batch_config.get('polling_interval', 'Not specified')} seconds")
    except Exception as e:
        logger.error(f"Error logging batch processing configuration: {e}")

    # Document type specific configuration
    if doc_type:
        logger.info("\nDocument Type Specific Configuration:")
        logger.info(f"  Current Document Type: {doc_type}")

    # Key Vault configuration
    logger.info("\nAzure Key Vault Configuration:")
    try:
        keyvault_config = config.get('azure_keyvault', {})
        logger.info(f"  Vault URL: {keyvault_config.get('vault_url', 'Not specified')}")
    except Exception as e:
        logger.error(f"Error logging Key Vault configuration: {e}")

    logger.info("\n" + "=" * 50)
    logger.info("CONFIGURATION LOGGING COMPLETE")
    logger.info("=" * 50)

    return logger
