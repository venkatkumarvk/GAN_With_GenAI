"""
Configurable RAG-Enhanced Document Extraction Prompts
All configurations in Python dictionaries - NO external JSON needed!

To add new fields: Just edit the FIELD_LIBRARY dictionary below
"""

import json
from typing import List, Dict, Any, Optional


# ============================================================================
# FIELD LIBRARY - EDIT THIS TO ADD NEW FIELDS
# ============================================================================

FIELD_LIBRARY = {
    "name": {
        "description": "Full name as it appears on the document",
        "examples": ["JOHN MICHAEL DOE", "Jane Smith", "李明"],
        "format": "First Middle Last or Last First format",
        "extraction_hints": [
            "May be split across multiple lines",
            "Check for 'Surname' and 'Given Names' labels",
            "Look for 'Full Name' or 'Name of Holder' sections"
        ],
        "confidence_factors": [
            "Clear text with proper spacing",
            "Consistent formatting across document",
            "Matches expected name pattern"
        ]
    },
    
    "passport_number": {
        "description": "Official passport identification number",
        "examples": ["AB123456", "P12345678", "N1234567890"],
        "format": "Alphanumeric, typically 7-10 characters",
        "extraction_hints": [
            "Usually labeled 'Passport No.', 'No. du Passeport'",
            "May appear multiple times (bio page and MRZ)",
            "Verify against MRZ if present"
        ],
        "confidence_factors": [
            "Clearly labeled as passport number",
            "Matches expected format for issuing country",
            "No OCR errors visible"
        ]
    },
    
    "date_of_birth": {
        "description": "Person's date of birth",
        "examples": ["15 JAN 1985", "1985-01-15", "01/15/1985"],
        "format": "Various date formats (DD MMM YYYY, YYYY-MM-DD, MM/DD/YYYY)",
        "extraction_hints": [
            "Look for 'Date of Birth', 'DOB', 'Born'",
            "May be in different formats based on country",
            "Cross-check with MRZ if available"
        ],
        "confidence_factors": [
            "Date is clearly labeled",
            "Consistent with other documents",
            "Reasonable age range"
        ]
    },
    
    "document_number": {
        "description": "General document identification number",
        "examples": ["DOC123456", "987654321", "AB-1234567"],
        "format": "Varies by document type and country",
        "extraction_hints": [
            "Look for 'Document Number', 'Doc No.', 'Number'",
            "May be different from passport or ID number",
            "Usually prominently displayed"
        ],
        "confidence_factors": [
            "Clearly labeled",
            "Matches expected format",
            "No OCR errors visible"
        ]
    },
    
    "nationality": {
        "description": "Country of citizenship",
        "examples": ["USA", "United States of America", "GBR", "United Kingdom"],
        "format": "Full country name or ISO 3166-1 alpha-3 code",
        "extraction_hints": [
            "Look for 'Nationality', 'Country', 'País'",
            "May match issuing country",
            "Can be in native language or English"
        ],
        "confidence_factors": [
            "Clearly stated on document",
            "Matches document issuing country",
            "Valid country name/code"
        ]
    },
    
    "issue_date": {
        "description": "Date when document was issued",
        "examples": ["01 MAR 2020", "2020-03-01", "March 1, 2020"],
        "format": "Various date formats accepted",
        "extraction_hints": [
            "Look for 'Date of Issue', 'Issued', 'Date délivrance'",
            "Should be in the past",
            "Usually 10 years before expiry for passports"
        ],
        "confidence_factors": [
            "Clearly labeled as issue date",
            "Before expiry date",
            "Reasonable time frame"
        ]
    },
    
    "expiry_date": {
        "description": "Date when document expires",
        "examples": ["01 MAR 2030", "2030-03-01", "March 1, 2030"],
        "format": "Various date formats accepted",
        "extraction_hints": [
            "Look for 'Date of Expiry', 'Valid Until', 'Expiry'",
            "Usually 10 years after issue for passports",
            "May be emphasized or highlighted"
        ],
        "confidence_factors": [
            "Clearly labeled as expiry date",
            "After issue date",
            "Standard validity period"
        ]
    },
    
    "sex": {
        "description": "Biological sex or gender",
        "examples": ["M", "F", "Male", "Female", "X"],
        "format": "Usually M/F or Male/Female",
        "extraction_hints": [
            "Look for 'Sex', 'Gender', 'Sexe'",
            "Usually single letter (M/F/X)",
            "Check MRZ for verification"
        ],
        "confidence_factors": [
            "Clearly labeled",
            "Standard format",
            "Unambiguous"
        ]
    },
    
    "address": {
        "description": "Full residential address",
        "examples": [
            "123 Main Street, New York, NY 10001",
            "Flat 5, 10 Downing Street, London",
            "北京市朝阳区建国路1号"
        ],
        "format": "Street, City, State/Province, Postal Code",
        "extraction_hints": [
            "May span multiple lines",
            "Look for 'Address', 'Residence', 'Domicile'",
            "Can be in various formats based on country"
        ],
        "confidence_factors": [
            "Clearly labeled as address",
            "Complete address components",
            "Proper formatting"
        ]
    },
    
    "email_address": {
        "description": "Email address",
        "examples": ["john.doe@email.com", "user@domain.co.uk", "name+tag@company.com"],
        "format": "user@domain format",
        "extraction_hints": [
            "Look for 'Email', 'E-mail', '@' symbol",
            "Usually contains @ symbol",
            "May be in lowercase"
        ],
        "confidence_factors": [
            "Contains @ symbol",
            "Valid email format",
            "Clearly labeled"
        ]
    },
    
    "degree": {
        "description": "Educational degree or qualification",
        "examples": ["B.S. Computer Science", "M.A. Psychology", "Ph.D. Engineering", "MBA"],
        "format": "Degree type followed by field of study",
        "extraction_hints": [
            "Look for 'Degree', 'Education', 'Qualification'",
            "Common formats: B.A., B.S., M.A., M.S., MBA, Ph.D., M.D., J.D.",
            "May include institution name"
        ],
        "confidence_factors": [
            "Clearly labeled",
            "Standard degree format",
            "Valid degree type"
        ]
    },
    
    # ========================================================================
    # ADD YOUR NEW FIELDS HERE - Just copy a template above and modify!
    # ========================================================================
    
    # Example: Add phone_number field
    # "phone_number": {
    #     "description": "Contact phone number",
    #     "examples": ["+1-555-123-4567", "(555) 123-4567"],
    #     "format": "International or local format",
    #     "extraction_hints": [
    #         "Look for 'Phone', 'Tel', 'Mobile'",
    #         "May include country code"
    #     ],
    #     "confidence_factors": [
    #         "Clearly labeled",
    #         "Correct number of digits"
    #     ]
    # },
}


# ============================================================================
# SYSTEM PROMPT CONFIGURATION
# ============================================================================

SYSTEM_PROMPT_CONFIG = {
    "role": "You are an expert document extraction system specialized in identity documents, passports, licenses, and official records.",
    
    "extraction_rules": [
        "Extract EXACT values as they appear in the document",
        "For each field, provide: value (extracted text or empty string) and confidence (0.0 to 1.0)",
        "Use similar document examples provided to improve accuracy",
        "If a field is not present, return empty string for value and 0.0 for confidence",
        "Be conservative with confidence scores - only use >0.9 when certain"
    ],
    
    "confidence_guide": {
        "0.95-1.0": "Clear, unambiguous text that exactly matches expected format",
        "0.80-0.94": "Text is clear but format slightly unusual",
        "0.60-0.79": "Text is readable but context suggests some uncertainty",
        "0.40-0.59": "Partial match or low quality OCR",
        "0.20-0.39": "Very uncertain, possibly misread",
        "0.0-0.19": "Field not found or illegible"
    },
    
    "output_format": 'Return ONLY a JSON object: {"field_name": {"value": "...", "confidence": 0.95}, ...}',
    
    "restrictions": "Do NOT include any explanations, markdown formatting, or additional text. Just the pure JSON object."
}


# ============================================================================
# DOCUMENT TYPE SPECIFIC HINTS
# ============================================================================

DOCUMENT_TYPE_HINTS = {
    "passport": {
        "title": "PASSPORT DOCUMENT EXTRACTION",
        "special_considerations": [
            "Passport numbers may include letters and numbers",
            "Dates are often in DD MMM YYYY format (e.g., 15 JAN 1990)",
            "Look for MRZ (Machine Readable Zone) at bottom",
            "Names may be split (Surname / Given Names)"
        ]
    },
    
    "license": {
        "title": "DRIVER'S LICENSE EXTRACTION",
        "special_considerations": [
            "License numbers vary by state/country",
            "May contain multiple date fields",
            "Address may span multiple lines",
            "License class indicates vehicle types"
        ]
    },
    
    "id_card": {
        "title": "ID CARD EXTRACTION",
        "special_considerations": [
            "ID formats vary significantly by country",
            "May have both front and back text",
            "Look for official stamps or holograms",
            "National ID numbers follow country-specific patterns"
        ]
    }
}


# ============================================================================
# MAIN PROMPT BUILDER CLASS
# ============================================================================

class ExtractionPromptBuilder:
    """Builds prompts dynamically from configurations above"""
    
    def __init__(self, fields: List[str]):
        """
        Initialize with list of fields to extract
        
        Args:
            fields: List of field names (must exist in FIELD_LIBRARY)
        """
        self.fields = fields
        self._validate_fields()
    
    def _validate_fields(self):
        """Validate that all fields have configurations"""
        missing = [f for f in self.fields if f not in FIELD_LIBRARY]
        if missing:
            print(f"⚠️  Warning: Missing configurations for fields: {', '.join(missing)}")
            print(f"   Add them to FIELD_LIBRARY in prompt.py")
    
    def build_system_prompt(
        self, 
        document_type: Optional[str] = None,
        ocr_quality: str = "high"
    ) -> str:
        """
        Build system prompt dynamically
        
        Args:
            document_type: Type of document (passport, license, id_card)
            ocr_quality: OCR quality level (low, medium, high)
        
        Returns:
            Complete system prompt string
        """
        parts = []
        
        # Role
        parts.append(SYSTEM_PROMPT_CONFIG['role'])
        parts.append("")
        
        # Task
        field_list = ", ".join(self.fields)
        parts.append(f"Your task is to extract the following fields from documents:")
        parts.append(field_list)
        parts.append("")
        
        # Extraction rules
        parts.append("EXTRACTION RULES:")
        for idx, rule in enumerate(SYSTEM_PROMPT_CONFIG['extraction_rules'], 1):
            parts.append(f"{idx}. {rule}")
        parts.append("")
        
        # Confidence guide
        parts.append("CONFIDENCE SCORING GUIDE:")
        for range_str, description in SYSTEM_PROMPT_CONFIG['confidence_guide'].items():
            parts.append(f"- {range_str}: {description}")
        parts.append("")
        
        # Document type hints
        if document_type and document_type in DOCUMENT_TYPE_HINTS:
            hints = DOCUMENT_TYPE_HINTS[document_type]
            parts.append(hints['title'])
            parts.append("Special considerations:")
            for consideration in hints['special_considerations']:
                parts.append(f"- {consideration}")
            parts.append("")
        
        # OCR quality adjustments
        if ocr_quality == "low":
            parts.append("OCR QUALITY NOTE: This text may contain OCR errors.")
            parts.append("- Be more conservative with confidence scores")
            parts.append("- Look for context clues to verify values")
            parts.append("- Consider common OCR mistakes (0/O, 1/I, 5/S, 8/B)")
            parts.append("")
        
        # Field details
        parts.append("DETAILED FIELD INFORMATION:")
        parts.append("")
        for field in self.fields:
            if field in FIELD_LIBRARY:
                info = FIELD_LIBRARY[field]
                parts.append(f"**{field}**:")
                parts.append(f"  Description: {info['description']}")
                parts.append(f"  Examples: {', '.join(info['examples'])}")
                parts.append(f"  Format: {info['format']}")
                
                if info.get('extraction_hints'):
                    parts.append("  Extraction Hints:")
                    for hint in info['extraction_hints']:
                        parts.append(f"    - {hint}")
                
                parts.append("")
        
        # Output format
        parts.append("OUTPUT FORMAT:")
        parts.append(SYSTEM_PROMPT_CONFIG['output_format'])
        parts.append("")
        parts.append(SYSTEM_PROMPT_CONFIG['restrictions'])
        
        return "\n".join(parts)
    
    def build_rag_user_prompt(
        self,
        document_text: str,
        visual_description: str = "",
        similar_examples: List[Dict[str, Any]] = None
    ) -> str:
        """
        Build user prompt with RAG examples
        
        Args:
            document_text: OCR text from current document
            visual_description: GPT-4o vision analysis (if multimodal)
            similar_examples: List of similar past extractions
        
        Returns:
            User prompt with examples
        """
        
        prompt_parts = []
        
        # Add similar examples if provided
        if similar_examples:
            prompt_parts.append(
                f"Here are {len(similar_examples)} similar documents with their extractions "
                f"as reference examples:\n\n"
            )
            
            for idx, example in enumerate(similar_examples, 1):
                similarity = example.get('@search.score', 0.0)
                doc_name = example.get('document_name', f'Example {idx}')
                extracted = example.get('extracted_fields', '{}')
                
                prompt_parts.append(f"EXAMPLE {idx} (similarity: {similarity:.2f})\n")
                prompt_parts.append(f"Document: {doc_name}\n")
                prompt_parts.append(f"Extraction:\n{extracted}\n\n")
            
            prompt_parts.append("="*60 + "\n\n")
        
        # Current document to extract
        prompt_parts.append("NOW EXTRACT FROM THIS NEW DOCUMENT:\n\n")
        
        # OCR text (PRIMARY source)
        prompt_parts.append("OCR TEXT (Primary Source):\n")
        prompt_parts.append(document_text[:8000])  # Limit to 8000 chars
        prompt_parts.append("\n\n")
        
        # Visual description (SUPPLEMENTARY, if multimodal)
        if visual_description:
            prompt_parts.append("VISUAL ANALYSIS (Supplementary):\n")
            prompt_parts.append(visual_description)
            prompt_parts.append("\n\n")
        
        # Remind of output format
        prompt_parts.append(f"Extract these fields: {', '.join(self.fields)}\n")
        prompt_parts.append("Return ONLY the JSON object with field values and confidence scores.\n")
        
        return "".join(prompt_parts)
    
    def get_field_info(self, field_name: str) -> Dict[str, Any]:
        """Get configuration for a specific field"""
        return FIELD_LIBRARY.get(field_name, {})
    
    @staticmethod
    def get_available_fields() -> List[str]:
        """Get list of all available fields"""
        return list(FIELD_LIBRARY.keys())
    
    @staticmethod
    def add_custom_field(field_name: str, field_config: Dict[str, Any]):
        """
        Add a custom field at runtime
        
        Args:
            field_name: Name of the field
            field_config: Field configuration dictionary
        """
        FIELD_LIBRARY[field_name] = field_config
        print(f"✓ Added custom field: {field_name}")


# ============================================================================
# HELPER FUNCTIONS
# ============================================================================

def print_available_fields():
    """Print all available fields in the library"""
    print("\n" + "="*70)
    print("AVAILABLE FIELDS IN LIBRARY")
    print("="*70)
    for idx, field in enumerate(FIELD_LIBRARY.keys(), 1):
        info = FIELD_LIBRARY[field]
        print(f"\n{idx}. {field}")
        print(f"   Description: {info['description']}")
        print(f"   Examples: {', '.join(info['examples'][:2])}")
    print("\n" + "="*70)


def validate_fields(fields: List[str]) -> Dict[str, Any]:
    """Validate that all fields have configurations"""
    missing = [f for f in fields if f not in FIELD_LIBRARY]
    configured = [f for f in fields if f in FIELD_LIBRARY]
    
    return {
        'valid': len(missing) == 0,
        'configured': configured,
        'missing': missing,
        'message': f"Missing: {', '.join(missing)}" if missing else "All fields configured ✓"
    }


# ============================================================================
# EXAMPLE USAGE
# ============================================================================

if __name__ == "__main__":
    print("="*70)
    print("CONFIGURABLE PROMPT BUILDER DEMO")
    print("="*70)
    
    # Show available fields
    print_available_fields()
    
    # Test fields
    fields = ["name", "passport_number", "date_of_birth", "nationality"]
    
    # Validate
    validation = validate_fields(fields)
    print(f"\nValidation: {validation['message']}")
    
    # Create builder
    builder = ExtractionPromptBuilder(fields)
    
    # Build system prompt
    system_prompt = builder.build_system_prompt(document_type="passport")
    
    print("\n" + "="*70)
    print("SYSTEM PROMPT:")
    print("="*70)
    print(system_prompt)
