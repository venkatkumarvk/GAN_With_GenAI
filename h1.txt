import fitz
import cv2
import numpy as np

# === Step 1: Detect largest rectangular contour ===
def detect_form_corners(img):
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    gray = cv2.GaussianBlur(gray, (5, 5), 0)
    edges = cv2.Canny(gray, 50, 150)

    contours, _ = cv2.findContours(edges, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

    if not contours:
        raise ValueError("No contours found for form boundary.")

    # Find largest contour
    cnt = max(contours, key=cv2.contourArea)

    # Approximate to polygon
    peri = cv2.arcLength(cnt, True)
    approx = cv2.approxPolyDP(cnt, 0.02 * peri, True)

    if len(approx) != 4:
        raise ValueError("Form boundary not detected as quadrilateral.")

    return np.float32([p[0] for p in approx])

# === Step 2: Remove white background ===
def remove_white_background(img):
    gray = cv2.cvtColor(img, cv2.COLOR_BGR2GRAY)
    _, alpha = cv2.threshold(gray, 240, 255, cv2.THRESH_BINARY_INV)
    b, g, r = cv2.split(img)
    return cv2.merge([b, g, r, alpha])

# === Step 3: Perspective transform ===
def warp_to_background(overlay_img, overlay_corners, bg_width, bg_height):
    target_corners = np.float32([
        [0, 0],
        [bg_width - 1, 0],
        [bg_width - 1, bg_height - 1],
        [0, bg_height - 1]
    ])
    M = cv2.getPerspectiveTransform(overlay_corners, target_corners)
    warped = cv2.warpPerspective(overlay_img, M, (bg_width, bg_height))
    return warped

# === Step 4: Main processing ===
background_pdf = "background.pdf"
overlay_pdf = "Sample 1500_2012_02_removed.pdf"
output_pdf = "final_overlay.pdf"

bg_doc = fitz.open(background_pdf)
overlay_doc = fitz.open(overlay_pdf)

# Background page dimensions in pixels
bg_pix = bg_doc[0].get_pixmap(dpi=300)
bg_width, bg_height = bg_pix.width, bg_pix.height

# Rasterize overlay PDF
pix = overlay_doc[0].get_pixmap(dpi=300)
overlay_img = np.frombuffer(pix.samples, dtype=np.uint8).reshape(pix.height, pix.width, pix.n)
if pix.n == 4:
    overlay_img = cv2.cvtColor(overlay_img, cv2.COLOR_BGRA2BGR)

# Detect corners & warp
overlay_corners = detect_form_corners(overlay_img)
overlay_warped = warp_to_background(overlay_img, overlay_corners, bg_width, bg_height)

# Remove white background
overlay_rgba = remove_white_background(overlay_warped)

# Convert RGBA to PNG bytes
_, buf = cv2.imencode(".png", overlay_rgba)
overlay_png_bytes = buf.tobytes()

# Insert PNG onto background PDF
page = bg_doc[0]
rect = fitz.Rect(0, 0, page.rect.width, page.rect.height)
page.insert_image(rect, stream=overlay_png_bytes)

# Save
bg_doc.save(output_pdf)
print(f"✅ Overlay complete → {output_pdf}")
